local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")

local event = ReplicatedStorage:WaitForChild("RemoteEvents"):WaitForChild("QueueJoinEvent")

-- í˜„ì¬ ëŒ€ê¸° ì¤‘ì¸ ëª¨ë“  í(ë°©)ë¥¼ ì €ì¥í•˜ëŠ” í…Œì´ë¸”
-- êµ¬ì¡°: { {players={p1, p2}, id="room1"}, {players={p3}, id="room2"} }
local activeQueues = {}

local MAX_PLAYERS = 4

------------------------------------------------------------------
-- [ë‚´ë¶€ í•¨ìˆ˜] íŠ¹ì • íì— ìˆëŠ” ëª¨ë“  ì‚¬ëŒì—ê²Œ ìƒíƒœ(ì¸ì›ìˆ˜) ì•Œë¦¬ê¸°
------------------------------------------------------------------
local function broadcastQueueStatus(queue)
	local currentCount = #queue.players
	
	for _, player in pairs(queue.players) do
		-- ê° í´ë¼ì´ì–¸íŠ¸ì—ê²Œ "QueueUpdate" ì‹ í˜¸ì™€ í˜„ì¬ ì¸ì›/ìµœëŒ€ ì¸ì›ì„ ë³´ëƒ„
		event:FireClient(player, "QueueUpdate", currentCount, MAX_PLAYERS)
	end
	
	print("ğŸ“¢ í ìƒíƒœ ì—…ë°ì´íŠ¸: " .. currentCount .. "/" .. MAX_PLAYERS)
	
	-- ë§Œì•½ 4ëª…ì´ ê½‰ ì°¼ë‹¤ë©´?
	if currentCount >= MAX_PLAYERS then
		print("ğŸš€ ë§¤ì¹­ ì„±ê³µ! ê²Œì„ ì‹œì‘ ì¤€ë¹„...")
		-- ì—¬ê¸°ì— ê²Œì„ ì‹œì‘ ë¡œì§ ì¶”ê°€ (SceneManager í˜¸ì¶œ ì‹ í˜¸ ë³´ë‚´ê¸° ë“±)
		-- ì˜ˆ: event:FireClient(player, "GameStart")
	end
end

------------------------------------------------------------------
-- [ë‚´ë¶€ í•¨ìˆ˜] ìœ ì €ê°€ ì´ë¯¸ ë‹¤ë¥¸ íì— ìˆëŠ”ì§€ í™•ì¸ (ì¤‘ë³µ ì°¸ì—¬ ë°©ì§€)
------------------------------------------------------------------
local function removePlayerFromQueues(player)
	for i, queue in pairs(activeQueues) do
		for j, p in pairs(queue.players) do
			if p == player then
				table.remove(queue.players, j)
				broadcastQueueStatus(queue) -- ë‚˜ê°”ìœ¼ë‹ˆ ë‚¨ì€ ì‚¬ëŒë“¤ì—ê²Œ ì—…ë°ì´íŠ¸
				
				-- ì‚¬ëŒì´ ì•„ë¬´ë„ ì—†ìœ¼ë©´ ë°© ì‚­ì œ
				if #queue.players == 0 then
					table.remove(activeQueues, i)
				end
				return
			end
		end
	end
end

------------------------------------------------------------------
-- [ë©”ì¸] í´ë¼ì´ì–¸íŠ¸ ìš”ì²­ ì²˜ë¦¬
------------------------------------------------------------------
event.OnServerEvent:Connect(function(player, requestType)
	
	if requestType == "JoinQueue" then
		print(player.Name .. "ë‹˜ì˜ í ì°¸ê°€ ìš”ì²­")
		
		-- 1. í˜¹ì‹œ ì´ë¯¸ ë“¤ì–´ê°€ ìˆìœ¼ë©´ ê¸°ì¡´ íì—ì„œ ì œê±° (ì•ˆì „ì¥ì¹˜)
		removePlayerFromQueues(player)
		
		-- 2. ë¹ˆ ìë¦¬ê°€ ìˆëŠ” í ì°¾ê¸°
		local foundQueue = nil
		
		for _, queue in pairs(activeQueues) do
			if #queue.players < MAX_PLAYERS then
				foundQueue = queue
				break
			end
		end
		
		-- 3. ë¹ˆ íê°€ ìˆìœ¼ë©´ ë„£ê³ , ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„±
		if foundQueue then
			table.insert(foundQueue.players, player)
			broadcastQueueStatus(foundQueue)
		else
			print("ë¹ˆ íê°€ ì—†ìŒ. ìƒˆë¡œ ìƒì„±í•©ë‹ˆë‹¤.")
			local newQueue = {
				players = { player },
				id = HttpService:GenerateGUID(false) -- ìœ ë‹ˆí¬ ID (í•„ìš”ì‹œ ì‚¬ìš©)
			}
			table.insert(activeQueues, newQueue)
			broadcastQueueStatus(newQueue)
		end
		
	elseif requestType == "LeaveQueue" then
		-- ì·¨ì†Œ ë²„íŠ¼ ëˆ„ë¥´ë©´ í˜¸ì¶œ
		removePlayerFromQueues(player)
	end
end)

-- [ì˜ˆì™¸ ì²˜ë¦¬] ìœ ì €ê°€ ê²Œì„ì„ ê°•ì œë¡œ ì¢…ë£Œí•˜ë©´ íì—ì„œ ë¹¼ì¤˜ì•¼ í•¨
Players.PlayerRemoving:Connect(function(player)
	removePlayerFromQueues(player)
end)