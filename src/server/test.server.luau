-- ğŸ”¹ ì„œë¹„ìŠ¤
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TriggerZone = workspace:WaitForChild("TriggerZone")

-- ğŸ”¹ ìŠ¤í°í•  ëª¨ë¸
local modelName = "CubeMouse_exp1"
local modelToSpawn = ReplicatedStorage:FindFirstChild(modelName)
if not modelToSpawn then
	warn(modelName .. " ëª¨ë¸ì„ ReplicatedStorageì—ì„œ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!")
	return
end

-- ğŸ”¹ ëª¨ë¸ í¬ê¸°
local dummy = modelToSpawn:Clone()
dummy.Parent = workspace
local modelSize = dummy:GetExtentsSize()
dummy:Destroy()

local stepX = modelSize.X
local stepZ = modelSize.Z

-- ğŸ”¹ í”Œë ˆì´ì–´ ìƒíƒœ ê´€ë¦¬
local activePlayers = {}
local debounce = {}

local zone = workspace.TriggerZone
local spawnY = zone.Position.Y - zone.Size.Y/2
-- ğŸ”¹ ë‚˜ì„ í˜• ì¢Œí‘œ ìƒì„±ê¸°
local function createSpiral(origin)
	local directions = {
		Vector3.new(0, 0, -stepZ),  -- ì•„ë˜
		Vector3.new(-stepX, 0, 0),  -- ì¢Œ
		Vector3.new(0, 0, stepZ),   -- ìœ„
		Vector3.new(stepX, 0, 0)    -- ìš°
	}
	local dirIndex = 1
	local stepsToTake = 1
	local stepsDone = 0
	local changeStep = 0
	local currentPos = origin

	return function()
		local posToReturn = currentPos
		local dir = directions[dirIndex]

		currentPos += dir
		stepsDone += 1

		if stepsDone >= stepsToTake then
			stepsDone = 0
			dirIndex += 1
			if dirIndex > 4 then dirIndex = 1 end

			changeStep += 1
			if changeStep == 2 then
				stepsToTake += 1
				changeStep = 0
			end
		end

		return posToReturn
	end
end

-- ğŸ”¹ ì¶©ëŒ ì²´í¬
local function isPositionFree(position)
	local parts = workspace:GetPartBoundsInRadius(position, math.max(stepX, stepZ)/2)
	return #parts == 0
end

-- ğŸ”¹ ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘
local function startSimulation(player)
	if activePlayers[player] then return end
	activePlayers[player] = true

	local origin = Vector3.new(TriggerZone.Position.X, -spawnY, TriggerZone.Position.Z)  -- ğŸ”¹ ê¸°ì¤€ ìœ„ì¹˜ë¥¼ TriggerZone ì¤‘ì‹¬ìœ¼ë¡œ
	local nextPos = createSpiral(origin)
	print("Next spawn position:", nextPos())

	task.spawn(function()
    while activePlayers[player] do
        local pos = nil

        -- ë¹„ì–´ìˆëŠ” ìœ„ì¹˜ ì°¾ê¸°
        local spiral = createSpiral(TriggerZone.Position)
        for i = 1, 100 do -- ìµœëŒ€ 100ì¹¸ íƒìƒ‰
            local candidate = spiral()
            if isPositionFree(candidate) then
                pos = candidate
                break
            end
        end

        if pos then
            local newModel = modelToSpawn:Clone()
            local size = newModel:GetExtentsSize()
            local targetPos = Vector3.new(pos.X, pos.Y + size.Y/2, pos.Z)
            newModel:PivotTo(CFrame.new(targetPos))
            newModel.Parent = workspace
        else
            warn("ìŠ¤í°í•  ë¹ˆ ê³µê°„ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤!")
        end

        task.wait(1) -- 1ì´ˆ ëŒ€ê¸°
    end
end)
end

-- ğŸ”¹ ì‹œë®¬ë ˆì´ì…˜ ì¢…ë£Œ
local function stopSimulation(player)
	activePlayers[player] = nil
end

-- ğŸ”¹ TriggerZone ê°ì§€
TriggerZone.Touched:Connect(function(hit)
	local humanoid = hit.Parent:FindFirstChildOfClass("Humanoid")
	if humanoid then
		local player = Players:GetPlayerFromCharacter(hit.Parent)
		if player and not activePlayers[player] and not debounce[player] then
			debounce[player] = true
			print(player.Name .. "ê°€ TriggerZoneì— ë“¤ì–´ì˜´!")
			startSimulation(player)
			task.delay(0.2, function()
				debounce[player] = false
			end)
		end
	end
end)

TriggerZone.TouchEnded:Connect(function(hit)
	local humanoid = hit.Parent:FindFirstChildOfClass("Humanoid")
	if humanoid then
		local player = Players:GetPlayerFromCharacter(hit.Parent)
		if player then
			print(player.Name .. "ê°€ TriggerZoneì—ì„œ ë‚˜ê°!")
			stopSimulation(player)
		end
	end
end)

-- ğŸ”¹ ì í”„ ê°ì§€
Players.PlayerAdded:Connect(function(player)
	player.CharacterAdded:Connect(function(character)
		local humanoid = character:WaitForChild("Humanoid")
		humanoid.StateChanged:Connect(function(_, newState)
			if newState == Enum.HumanoidStateType.Jumping then
				stopSimulation(player)
				print(player.Name .. "ê°€ ì í”„í•˜ì—¬ ì‹œë®¬ë ˆì´ì…˜ ì¢…ë£Œ")
			end
		end)
	end)
end)
